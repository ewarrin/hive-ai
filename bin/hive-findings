#!/usr/bin/env bash
# Hive Findings - View and manage code review findings
#
# Usage: hive findings [list|show|triage] [options]

set -e

HIVE_ROOT="${HIVE_ROOT:-$HOME/.hive}"
HIVE_DIR="${HIVE_DIR:-.hive}"

# Source findings library
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/../lib/findings.sh"

# ============================================================================
# Colors
# ============================================================================

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

# ============================================================================
# Helpers
# ============================================================================

get_current_run() {
    local latest=""
    if [ -d "$HIVE_DIR/runs" ]; then
        local latest_dir=$(ls -td "$HIVE_DIR/runs"/*/ 2>/dev/null | grep -v _subagents | head -1)
        [ -n "$latest_dir" ] && latest=$(basename "$latest_dir")
    fi
    echo "$latest"
}

# ============================================================================
# Commands
# ============================================================================

cmd_list() {
    local run_id="${1:-$(get_current_run)}"
    local severity_filter="${2:-}"
    
    if [ -z "$run_id" ]; then
        echo "No runs found."
        exit 1
    fi
    
    local findings_file="$HIVE_DIR/runs/$run_id/findings.json"
    
    if [ ! -f "$findings_file" ]; then
        echo "No findings for run: $run_id"
        exit 0
    fi
    
    local data=$(cat "$findings_file")
    
    echo ""
    echo -e "${BOLD}Findings for run: $run_id${NC}"
    echo -e "${DIM}─────────────────────────────────────────${NC}"
    echo ""
    
    # Filter query
    local filter='.findings[]'
    if [ -n "$severity_filter" ]; then
        filter=".findings[] | select(.severity == \"$severity_filter\")"
    fi
    
    echo "$data" | jq -r "$filter | \"\(.severity | ascii_upcase)  \(.id)  \(.title)  [\(.file):\(.line // \"-\")]  (\(.status))\"" 2>/dev/null | while read -r line; do
        local sev=$(echo "$line" | cut -d' ' -f1)
        case "$sev" in
            BLOCKER) echo -e "  ${RED}●${NC} $line" ;;
            HIGH)    echo -e "  ${YELLOW}●${NC} $line" ;;
            MEDIUM)  echo -e "  ${BLUE}●${NC} $line" ;;
            LOW)     echo -e "  ${DIM}●${NC} $line" ;;
            *)       echo "  ○ $line" ;;
        esac
    done
    
    echo ""
    
    # Summary
    local total=$(echo "$data" | jq '.summary.total')
    local blocker=$(echo "$data" | jq '.summary.blocker')
    local high=$(echo "$data" | jq '.summary.high')
    local medium=$(echo "$data" | jq '.summary.medium')
    local low=$(echo "$data" | jq '.summary.low')
    
    echo -e "${DIM}Total: $total (${NC}${RED}$blocker blocker${NC}${DIM}, ${NC}${YELLOW}$high high${NC}${DIM}, ${NC}${BLUE}$medium medium${NC}${DIM}, $low low)${NC}"
    echo ""
}

cmd_show() {
    local finding_id="$1"
    local run_id="${2:-$(get_current_run)}"
    
    if [ -z "$finding_id" ]; then
        echo "Usage: hive findings show <finding_id> [run_id]"
        exit 1
    fi
    
    local findings_file="$HIVE_DIR/runs/$run_id/findings.json"
    
    if [ ! -f "$findings_file" ]; then
        echo "No findings for run: $run_id"
        exit 1
    fi
    
    _findings_view_detail "$findings_file" <<< "$finding_id"
}

cmd_triage() {
    local run_id="${1:-$(get_current_run)}"
    
    if [ -z "$run_id" ]; then
        echo "No runs found."
        exit 1
    fi
    
    local findings_file="$HIVE_DIR/runs/$run_id/findings.json"
    
    if [ ! -f "$findings_file" ]; then
        echo "No findings for run: $run_id"
        exit 0
    fi
    
    # Get epic_id from scratchpad
    local epic_id=""
    if [ -f "$HIVE_DIR/scratchpad.json" ]; then
        epic_id=$(jq -r '.epic_id // ""' "$HIVE_DIR/scratchpad.json")
    fi
    
    findings_triage_ui "$run_id" "$epic_id"
}

cmd_summary() {
    local run_id="${1:-$(get_current_run)}"
    
    if [ -z "$run_id" ]; then
        echo "No runs found."
        exit 1
    fi
    
    local findings_file="$HIVE_DIR/runs/$run_id/findings.json"
    
    if [ ! -f "$findings_file" ]; then
        echo "No findings for run: $run_id"
        exit 0
    fi
    
    _findings_display "$findings_file"
}

# ============================================================================
# Main
# ============================================================================

main() {
    local command="${1:-summary}"
    shift 2>/dev/null || true
    
    case "$command" in
        list|ls)
            cmd_list "$@"
            ;;
        show|view)
            cmd_show "$@"
            ;;
        triage)
            cmd_triage "$@"
            ;;
        summary|"")
            cmd_summary "$@"
            ;;
        -h|--help|help)
            echo "Usage: hive findings <command> [options]"
            echo ""
            echo "Commands:"
            echo "  summary         Show findings summary (default)"
            echo "  list [--sev X]  List all findings"
            echo "  show <id>       Show finding details"
            echo "  triage          Launch interactive triage UI"
            echo ""
            echo "Options:"
            echo "  --run <id>      Specify run ID (default: latest)"
            echo "  --sev <level>   Filter by severity (blocker, high, medium, low)"
            exit 0
            ;;
        *)
            echo "Unknown command: $command"
            echo "Run 'hive findings help' for usage."
            exit 1
            ;;
    esac
}

main "$@"
