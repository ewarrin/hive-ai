#!/usr/bin/env bash
# Hive Git - Manual git integration controls
#
# Usage: hive git [status|branch|commit|pr|cleanup]

set -e

HIVE_ROOT="${HIVE_ROOT:-$HOME/.hive}"
HIVE_DIR="${HIVE_DIR:-.hive}"

# Source git library
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/../lib/git.sh"

# ============================================================================
# Colors
# ============================================================================

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

# ============================================================================
# Helpers
# ============================================================================

get_current_run_id() {
    if [ -d "$HIVE_DIR/runs" ]; then
        local latest=$(ls -td "$HIVE_DIR/runs"/*/ 2>/dev/null | grep -v _subagents | head -1)
        [ -n "$latest" ] && basename "$latest"
    fi
}

# ============================================================================
# Commands
# ============================================================================

cmd_status() {
    local run_id=$(get_current_run_id)
    local git_file="$HIVE_DIR/runs/$run_id/git_state.json"
    
    echo ""
    echo -e "${BOLD}Git Status${NC}"
    echo -e "${DIM}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo ""
    
    if ! git rev-parse --git-dir &>/dev/null; then
        echo -e "  ${YELLOW}Not a git repository${NC}"
        echo ""
        return
    fi
    
    # Current branch
    local current_branch=$(git branch --show-current)
    echo -e "  ${DIM}Current branch:${NC}  ${CYAN}$current_branch${NC}"
    
    # Hive state
    if [ -f "$git_file" ]; then
        local work_branch=$(jq -r '.work_branch // ""' "$git_file")
        local original_branch=$(jq -r '.original_branch // ""' "$git_file")
        local commit_count=$(jq -r '.commits | length' "$git_file")
        local pr_url=$(jq -r '.pr_url // ""' "$git_file")
        
        echo -e "  ${DIM}Hive branch:${NC}     ${CYAN}$work_branch${NC}"
        echo -e "  ${DIM}Original branch:${NC} $original_branch"
        echo -e "  ${DIM}Commits:${NC}         $commit_count"
        
        if [ -n "$pr_url" ] && [ "$pr_url" != "null" ]; then
            echo -e "  ${DIM}Pull Request:${NC}    ${GREEN}$pr_url${NC}"
        fi
        
        echo ""
        
        # Show commits
        if [ "$commit_count" -gt 0 ]; then
            echo -e "${BOLD}Commits:${NC}"
            jq -r '.commits[] | "  \(.hash) [\(.agent)] \(.message)"' "$git_file" 2>/dev/null
            echo ""
        fi
    else
        echo -e "  ${DIM}No Hive git state for this run${NC}"
        echo ""
    fi
    
    # Uncommitted changes
    local changes=$(git status --porcelain | wc -l | tr -d ' ')
    if [ "$changes" -gt 0 ]; then
        echo -e "  ${YELLOW}$changes uncommitted change(s)${NC}"
        git status --short | head -10 | sed 's/^/    /'
        [ "$changes" -gt 10 ] && echo "    ..."
        echo ""
    fi
}

cmd_branch() {
    local objective="$1"
    local run_id=$(get_current_run_id)
    
    if [ -z "$objective" ]; then
        echo "Usage: hive git branch \"objective description\""
        echo ""
        echo "Creates a new branch based on the objective."
        return 1
    fi
    
    if ! git rev-parse --git-dir &>/dev/null; then
        echo -e "${RED}Not a git repository${NC}"
        return 1
    fi
    
    local branch_name=$(git_generate_branch_name "$objective" "$run_id")
    
    echo -e "Creating branch: ${CYAN}$branch_name${NC}"
    
    if git show-ref --verify --quiet "refs/heads/$branch_name"; then
        echo -e "${YELLOW}Branch exists, checking out${NC}"
        git checkout "$branch_name"
    else
        git checkout -b "$branch_name"
    fi
    
    echo -e "${GREEN}âœ“${NC} On branch: $branch_name"
}

cmd_commit() {
    local message="$1"
    local run_id=$(get_current_run_id)
    
    if [ -z "$message" ]; then
        echo "Usage: hive git commit \"commit message\""
        return 1
    fi
    
    if ! git rev-parse --git-dir &>/dev/null; then
        echo -e "${RED}Not a git repository${NC}"
        return 1
    fi
    
    if git diff --quiet && git diff --staged --quiet; then
        echo -e "${DIM}No changes to commit${NC}"
        return 0
    fi
    
    git add -A
    git commit -m "$message

ðŸ Hive run: $run_id" --no-verify
    
    echo -e "${GREEN}âœ“${NC} Committed: $message"
}

cmd_pr() {
    local run_id=$(get_current_run_id)
    local git_file="$HIVE_DIR/runs/$run_id/git_state.json"
    
    if ! git rev-parse --git-dir &>/dev/null; then
        echo -e "${RED}Not a git repository${NC}"
        return 1
    fi
    
    # Load git state
    if [ -f "$git_file" ]; then
        git_load_state "$run_id"
    fi
    
    local current_branch=$(git branch --show-current)
    local base_branch="${_GIT_ORIGINAL_BRANCH:-main}"
    
    # Check for existing PR
    if [ -f "$git_file" ]; then
        local existing_pr=$(jq -r '.pr_url // ""' "$git_file")
        if [ -n "$existing_pr" ] && [ "$existing_pr" != "null" ]; then
            echo -e "PR already exists: ${GREEN}$existing_pr${NC}"
            return 0
        fi
    fi
    
    if ! command -v gh &>/dev/null; then
        echo -e "${YELLOW}GitHub CLI (gh) not installed${NC}"
        echo ""
        echo "Install with: brew install gh"
        echo ""
        echo "Manual PR creation:"
        echo "  Branch: $current_branch"
        echo "  Base: $base_branch"
        echo "  Push: git push -u origin $current_branch"
        return 1
    fi
    
    if ! gh auth status &>/dev/null 2>&1; then
        echo -e "${YELLOW}GitHub CLI not authenticated${NC}"
        echo "Run: gh auth login"
        return 1
    fi
    
    # Get objective for title
    local objective=""
    if [ -f "$HIVE_DIR/scratchpad.json" ]; then
        objective=$(jq -r '.objective // ""' "$HIVE_DIR/scratchpad.json")
    fi
    
    local title="${objective:-$(git log -1 --format=%s)}"
    [ ${#title} -gt 60 ] && title="${title:0:57}..."
    
    echo -e "Creating PR: ${BOLD}$title${NC}"
    echo -e "  From: ${CYAN}$current_branch${NC}"
    echo -e "  To:   $base_branch"
    echo ""
    
    # Push branch
    echo "Pushing branch..."
    git push -u origin "$current_branch"
    
    # Create PR
    local pr_url=$(gh pr create \
        --title "$title" \
        --body "## Hive Run

Created by Hive automation.

### Commits
$(git log --oneline "$base_branch..$current_branch" | sed 's/^/- /')

---
ðŸ *Automated by Hive*" \
        --base "$base_branch" \
        --head "$current_branch" \
        2>&1)
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}âœ“${NC} Pull request created: $pr_url"
        
        # Save PR URL
        if [ -f "$git_file" ]; then
            local tmp=$(mktemp)
            jq --arg url "$pr_url" '.pr_url = $url' "$git_file" > "$tmp" && mv "$tmp" "$git_file"
        fi
    else
        echo -e "${RED}Failed to create PR${NC}"
        echo "$pr_url"
        return 1
    fi
}

cmd_cleanup() {
    local run_id=$(get_current_run_id)
    local git_file="$HIVE_DIR/runs/$run_id/git_state.json"
    
    if ! git rev-parse --git-dir &>/dev/null; then
        echo -e "${RED}Not a git repository${NC}"
        return 1
    fi
    
    local work_branch=""
    local original_branch="main"
    
    if [ -f "$git_file" ]; then
        work_branch=$(jq -r '.work_branch // ""' "$git_file")
        original_branch=$(jq -r '.original_branch // "main"' "$git_file")
    fi
    
    if [ -z "$work_branch" ]; then
        echo -e "${DIM}No Hive branch to clean up${NC}"
        return 0
    fi
    
    local current_branch=$(git branch --show-current)
    
    echo -e "This will delete branch: ${CYAN}$work_branch${NC}"
    read -p "Are you sure? [y/N] " -n 1 -r
    echo ""
    
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Cancelled."
        return 0
    fi
    
    # Switch to original branch if on work branch
    if [ "$current_branch" = "$work_branch" ]; then
        echo "Switching to $original_branch..."
        git checkout "$original_branch"
    fi
    
    # Delete local branch
    git branch -D "$work_branch" 2>/dev/null || true
    
    # Delete remote branch
    git push origin --delete "$work_branch" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“${NC} Cleaned up branch: $work_branch"
}

cmd_diff() {
    local run_id=$(get_current_run_id)
    local git_file="$HIVE_DIR/runs/$run_id/git_state.json"
    
    if ! git rev-parse --git-dir &>/dev/null; then
        echo -e "${RED}Not a git repository${NC}"
        return 1
    fi
    
    local original_branch="main"
    if [ -f "$git_file" ]; then
        original_branch=$(jq -r '.original_branch // "main"' "$git_file")
    fi
    
    local current_branch=$(git branch --show-current)
    
    echo -e "${BOLD}Changes from $original_branch to $current_branch${NC}"
    echo ""
    
    git diff --stat "$original_branch..$current_branch" 2>/dev/null || git diff --stat HEAD~5
}

# ============================================================================
# Main
# ============================================================================

main() {
    local command="${1:-status}"
    shift 2>/dev/null || true
    
    case "$command" in
        status|st)
            cmd_status
            ;;
        branch|br)
            cmd_branch "$@"
            ;;
        commit|ci)
            cmd_commit "$@"
            ;;
        pr|pull-request)
            cmd_pr
            ;;
        cleanup|clean)
            cmd_cleanup
            ;;
        diff)
            cmd_diff
            ;;
        -h|--help|help)
            echo "Usage: hive git <command> [options]"
            echo ""
            echo "Commands:"
            echo "  status          Show git status for current run"
            echo "  branch \"desc\"   Create a new branch from description"
            echo "  commit \"msg\"    Commit all changes with message"
            echo "  pr              Create a pull request"
            echo "  diff            Show diff from original branch"
            echo "  cleanup         Delete the Hive work branch"
            echo ""
            echo "Git integration is automatic during 'hive run'."
            echo "These commands are for manual control."
            ;;
        *)
            echo "Unknown command: $command"
            echo "Run 'hive git help' for usage."
            exit 1
            ;;
    esac
}

main "$@"
